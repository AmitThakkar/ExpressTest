"use strict";

exports.initializeApplication = function () {
    var application = this;
    var fs = require('fs');
    var _ = require('underscore');
    var mongoose = require('mongoose');
    mongoose.connect(application.config.dataSource.mongo.url);
    var applicationContext = require(process.cwd() + "/config/ApplicationContext");
    console.log("****************************************************************************************");
    console.log("Connection to Database -> ", application.config.dataSource.mongo.url);
    console.log("****************************************************************************************\n\n");
    var dependencies = {};
    fs.readdir("./domain", function (error, domainFileNames) {
        if (error) {
            console.log("Error occur at the time of reading Services");
        } else if (domainFileNames && domainFileNames.length > 0) {
            domainFileNames.forEach(function (domain) {
                dependencies[/(.*)(.js)/g.exec(domain)[1]] = require("../../../domain/" + domain);
            });
        }
        fs.readdir("./service", function (error, serviceFileNames) {
            if (error) {
                console.log("Error occur at the time of reading Services");
            } else if (serviceFileNames && serviceFileNames.length > 0) {
                serviceFileNames.forEach(function (serviceFileName) {
                    dependencies[/(.*)(.js)/g.exec(serviceFileName)[1]] = require("../../../service/" + serviceFileName);
                });
                serviceFileNames.forEach(function (serviceFileName) {
                    var serviceName = /(.*)(.js)/g.exec(serviceFileName)[1];
                    _.each(dependencies[serviceName].dependencies, function (value, dependency) {
                        dependencies[serviceName].dependencies[dependency] = dependencies[dependency];
                    });
                    if (applicationContext[serviceName]) {
                        _.each(applicationContext[serviceName], function (value, key) {
                            dependencies[serviceName].dependencies[key] = dependencies[value];
                        });
                    }
                });
            }
            fs.readdir("./controller", function (error, controllerFileNames) {
                if (error) {
                    console.log("Error Occur at the time of reading Controllers");
                } else if (controllerFileNames && controllerFileNames.length > 0) {
                    controllerFileNames.forEach(function (controllerFileName) {
                        var controller = /(.*)(Controller)/.exec(controllerFileName)[1];
                        var controllerObject = require("../../../controller/" + controllerFileName);
                        _.each(controllerObject.actions, function (handler, actionName) {
                            var methodSupported = controllerObject.allowedMethods[actionName];
                            if (methodSupported && methodSupported.length > 0) {
                                controllerObject.allowedMethods[actionName].forEach(function (methodName) {
                                    switch (actionName) {
                                        case "get" :
                                        case "delete" :
                                            application[methodName.toLowerCase()]('/' + controller + "/" + actionName + "/:id", handler);
                                            break;
                                        case "list":
                                            application[methodName.toLowerCase()]('/' + controller + "/" + actionName + "/:max/:offset", handler);
                                            break;
                                    }
                                    application[methodName.toLowerCase()]('/' + controller + "/" + actionName, handler);
                                });
                            } else {
                                application["all"]('/' + controller + "/" + actionName, handler);
                            }
                        });
                        _.each(controllerObject.dependencies, function (value, dependency) {
                            controllerObject.dependencies[dependency] = dependencies[dependency];
                        });
                        var controllerName = controller + "Controller";
                        if (applicationContext[controllerName]) {
                            _.each(applicationContext[controllerName], function (value, key) {
                                controllerObject.dependencies[key] = dependencies[value];
                            });
                        }
                    });
                } else {
                    console.log("No Controller found");
                }
            });
        });
    });
};